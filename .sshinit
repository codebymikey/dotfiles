#!/usr/bin/env bash

#SSH_AGENT_METHOD=none
SSH_AGENT_METHOD=${SSH_AGENT_METHOD:-none}

if [ "$SSH_AGENT_METHOD" = 'keychain' ]; then
  ###########################################################################
  # allow $USER to use keys. Only enter once and it will remain enabled till
  # you delete it or reboot the server
  ###########################################################################
  SSH_KEYCHAIN_DEBUG=${SSH_KEYCHAIN_DEBUG-false}
  if [ "${SSH_KEYCHAIN_DEBUG}" = true ]; then
    set -x
  fi
  if test -f "$HOME/.keychain/$HOSTNAME-sh"; then
    # shellcheck disable=SC1090
    source "$HOME/.keychain/$HOSTNAME-sh"
  fi
  if test -n "$SSH_AGENT_PID" && test -n "$SSH_AUTH_SOCK"; then
    if ! ps -p "$SSH_AGENT_PID" >/dev/null || ! test -S "$SSH_AUTH_SOCK"; then
      :
      # Restarting the keychain service.
      echo "Restarting keychain: $SSH_AGENT_PID ($SSH_AUTH_SOCK)"
      # unset SSH_AGENT_PID; unset SSH_AUTH_SOCK;
      keychain --stop all
      # rm -rf "$HOME/.keychain/$HOSTNAME-sh"
    fi
  fi
  keychain --quiet --quick "$HOME/.ssh/id_rsa" # --noask --clear
  # shellcheck disable=SC1090
  source "$HOME/.keychain/$HOSTNAME-sh"
  if [ "${SSH_KEYCHAIN_DEBUG}" = true ]; then
    set +x
  fi
elif [ "$SSH_AGENT_METHOD" = 'wsl2-ssh-pageant' ]; then
  #eval $(ssh-pageant.exe)
  #SSH_AUTH_SOCK="${SSH_AUTH_SOCK/\/tmp//mnt/c/Users/$USER/AppData/Local/Temp}"
  #export SSH_AUTH_SOCK
  # https://github.com/BlackReloaded/wsl2-ssh-pageant
  export SSH_AUTH_SOCK="$HOME/.ssh/agent.sock"
  if ! ss -a | grep -q "$SSH_AUTH_SOCK"; then
    rm -f "$SSH_AUTH_SOCK"
    wsl2_ssh_pageant_bin="/usr/local/bin/wsl2-ssh-pageant.exe"
    if [ -x "$wsl2_ssh_pageant_bin" ]; then
      wsl2_ssh_pageant_verbose_arg=''
      wsl2_ssh_pageant_verbose_arg=' -verbose'
      (setsid nohup socat "UNIX-LISTEN:$SSH_AUTH_SOCK,fork" "EXEC:$wsl2_ssh_pageant_bin -logfile $HOME/wsl2-ssh-pageant.log${wsl2_ssh_pageant_verbose_arg}" >/dev/null 2>&1 &)
      # ncat -U "$SSH_AUTH_SOCK" < /dev/null; echo $?
      unset wsl2_ssh_pageant_verbose_arg
    else
      echo >&2 "$wsl2_ssh_pageant_bin is not executable."
    fi
    unset wsl2_ssh_pageant_bin
  fi
fi

IFS=':' read -ra SSH_EXTRA_KEYS_ARRAY <<<"$(echo -n "${SSH_EXTRA_KEYS-}" | tr '\n' ':')"
if [ "${#SSH_EXTRA_KEYS_ARRAY[@]}" -gt 0 ]; then
  if timeout 1 ssh-add -l > /dev/null; then
    # Active ssh agent, attempt to add keys to it.
    fingerprints=$(ssh-add -l)
    for extra_key in "${SSH_EXTRA_KEYS_ARRAY[@]}"; do
      # https://stackoverflow.com/a/13034313
      if [ -f "$extra_key" ] && ! echo -n "$fingerprints" | grep -q "$(ssh-keygen -lf "$extra_key")" >/dev/null; then
        ssh-add "$extra_key"
      fi
    done
  fi
fi
